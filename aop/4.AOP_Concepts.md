# AOP Concepts
## AOP (Aspect-Oriented-Programming)
- 부가 기능은 핵심 기능을 보조하기 위한 것으로 보통 횡단 관심사, 즉 여러 기능에 거쳐 적용된다.
- 부가 기능 도입을 위한 노력
    - 부가 기능을 한 곳에서 관리하도록 한다.
    - 해당 부가 기능을 어디에 적용할 지 필터링한다.
- **Aspect는 이렇게 부가 기능과 부가 기능을 어디에 적용할지 선택하는 기능을 합해 하나의 모듈**로 만든 것
- 스프링이 제공하는 어드바이저도 포인트컷 + 어드바이스를 가지므로 개념상 하나의 애스펙트이다.
- Aspect = “관점”
    - 애플리케이션을 바라보는 관점을 하나하나의 기능 대신 횡단 관심사 관점으로 바라보는 것
    - 애스펙트를 사용한 프로그래밍 방식을 관점 지향 프로그래밍 AOP라고 한다.
- AOP의 목적
    - 횡단 관심사를 깔끔하게 처리하기 어려운 OOP의 부족한 부분을 보조하기 위함
    - OOP를 대체하기 위함은 아니다.

### `AspectJ 프레임워크`
- AOP의 대표적인 구현으로 AspectJ 프레임워크가 존재한다. 
- 자바 프로그래밍 언어에 대한 완벽한 관점 지향 확장을 위한 프레임워크
- 횡단 관심사의 깔끔한 모듈화
    - 오류 검사 및 처리
    - 동기화
    - 성능 최적화(캐싱)
    - 모니터링 및 로깅
- **스프링도 AOP를 지원하나 직접 AspectJ를 사용하는 것은 아니다.**
    - 대부분 AspectJ의 문법을 차용하고, AspectJ가 제공하는 기능의 일부만 제공한다.
    - 스프링 AOP는 프록시 방식의 AOP를 제공한다.

## AOP 적용 방식
AOP를 사용하여 부가 기능 적용 시에 실제 로직에 추가되는 방식은 3가지가 존재한다.
- 컴파일 시점
- 클래스 로딩 시점
- 런타임 시점(프록시)

### 컴파일 시점 위빙
- .java 소스 코드를 컴파일하여 .class 파일로 만드는 시점에 부가 로직을 추가하는 방식이다.
- AspectJ 컴파일러를 사용해야 한다.
- .class 파일을 디컴파일해보면 애스펙트 관련 호출 코드가 핵심 로직에 들어가 있는 것을 확인할 수 있다.
- 이렇게 원본 로직에 부가 기능이 추가되는 것을 **위빙(weaving)**이라고 한다.
- 단점
    - 특별히 AspectJ 컴파일러가 필요하며 복잡하다.

___

### 클래스 로딩 시점 위빙
- 자바는 실행하면 .class 파일을 JVM 내부 클래스 로더에 보관한다.
- 이때 JVM에 .class 파일을 로딩하는 시점에 파일을 조작한 다음 올리는 방식이다.
- 자바 언어는 .class를 JVM에 올리기 전에 조작할 수 있는 기능을 제공한다. (java Instrumentation)
- 수 많은 모니터링 툴들이 이 방식을 사용한다.
- 단점
    - .class 의 바이트 코드 조작을 위해선 AspectJ 클래스 로더 조작기를 사용해야 한다.
    - 자바를 실행할 때 특별한 옵션(`java -javaagent` )을 통해 클래스 로더 조작기를 지정해야 하는 데, 이 부분이 번거로우며 운영하기가 어렵다.

___

### 런타임 시점 위빙
- 우리가 사용하는 프록시 방식의 AOP이다.
- 런타임 시점은 컴파일도 완료되고, JVM에 클래스 로딩도 다 끝난 후 자바가 실행된 시점을 말한다.
    - 즉, 자바의 main 메서드가 실행된 이후이다.
- DI, 빈 포스트 프로세서, 프록시 개념을 모두 사용하여 부가 기능을 적용하면 된다.
- 실제 원본 코드 자체를 조작해버리는 앞 방식과 달리 프록시를 사용하므로 AOP 기능의 일부 제약은 있다.
- 항상 프록시를 통해서만 부가 기능을 적용할 수 있다.
- 장점: 특별한 컴파일러나 클래스 로더 조작기가 필요하지 않다.
- Spring AOP 는 이 AOP 방식을 사용한다.

___

### AOP 적용 위치에서의 차이점
- AOP 를 적용하는 지점을 모두 JoinPoint 라고 하며 다양한 곳에 적용할 수 있다. 
- 적용 가능 지점엔 생성자, 필드 값 접근, static 메서드 접근, 메서드 실행이 있다.
- AspectJ 를 직접 상요하는 컴파일 시점, 로딩 시점 위빙은 실제 바이트 코드를 조작하므로 모든 지점이 joinpoint 가 될 수 있다. 
- 하지만 런타임 위빙 - 프록시 기반 AOP 방식은 조인 포인트 제약이 있다.
    - 프록시는 메서드 오버라이딩을 기반으로 동작하므로 무조건 메서드 실행에만 적용 가능하다.
    - 프록시의 특정 메서드 호출 -> 포인트컷 확인 -> 어드바이스 호출 -> target 호출
- 그럼에도 AspectJ 를 직접 사용하지 않는 이유는?
    - AspectJ 는 자바 관련 설정이 복잡하지만, Spring AOP 는 별도 어려운 설정 없이 쉽게 사용할 수 있다.
    - 실제론 Spring AOP 가 제공하는 기능만으로 대부분 문제 해결이 가능하다고 한다.

## AOP 용어
- **조인** **포인트**(Join point)
    - AOP가 적용될 수 있는 위치를 말한다.
    - 메소드 실행, 생성자 호출, 필드 값 접근, static 메서드 접근
    - 스프링 AOP는 프록시 방식이므로 조인 포인트는 메소드 실행 지점으로 제한된다.
- **포인트컷**(Pointcut)
    - 어드바이스가 적용될 위치를 선별하는 기능
    - 주로 AspectJ 표현식을 사용해서 지정
    - 프록시 기반 스프링 AOP는 메서드 실행 지점만 포인트컷으로 선별 가능하다.
- **타켓**(Target)
    - 어드바이스를 받는 객체, 포인트컷으로 결정
    - 프록시가 적용되는 실제 대상이다.
- **어드바이스**(Advice)
    - 부가 기능
    - 특정 조인 포인트에서 Aspect에 의해 취해지는 조치
    - Around(주변), Before(전), After(후)와 같은 어드바이스가 존재
- **애스펙트**(Aspect)
    - 어드바이스 + 포인트컷을 모듈화 한 것
    - @Aspect
    - 여러 어드바이스와 포인트 컷이 함께 존재할 수 있다.
- **어드바이저**(Advisor)
    - 하나의 어드바이스 + 하나의 포인트 컷
    - 스프링 AOP에서만 사용되는 특별한 용어이다.
- **위빙**(Weaving)
    - 애스펙트와 실제 코드를 연결해서 붙이는 것
    - 포인트컷으로 결정한 타켓의 조인 포인트에 어드바이스를 적용하는 것
    - 위빙을 통해 핵심 기능 코드에 영향을 주지 않고 부가 기능을 추가 할 수 있음
    - 3가지 위빙 방식
        - 컴파일 타임
        - 클래스 로드 타임
        - 런타임 시점