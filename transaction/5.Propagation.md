# Transaction Propagation
## PROPAGATION_REQUIRED
- 트랜잭션이 아직 없다면 현재 범위 내에서 새로운 트랜잭션을 생성한다.
- 하지만, 이미 더 큰 범위에서 정의된 외부 트랜잭션이 있다면 그 트랜잭션에 참여한다.
- 이것은 일반적으로 같은 스레드 내에서 호출 스택이 연결된 구조와 같다.
    - ex. 서비스에서 여러 리포지토리 메서드에 위임할 때 각 리포지토리는 서비스 계층의 트랜잭션에 참여한다.
- default 설정, 아무런 속성을 지정하지 않으면 이 설정이 적용됨
- 특징
    - REQUIRED 가 명시된 각 메서드는 논리적 트랜잭션 범위를 가진다.
    - 이 논리적 범위는 각각 독립적으로 rollback-only 상태를 설정할 수 있다.
    - 이 논리적 트랜잭션 범위는 모두 하나의 물리 트랜잭션에 매핑된다.
    - 논리 트랜잭션은 물리 트랜잭션을 관리하는 외부 트랜잭션이 최종적으로 커밋될 때 커밋되고, 롤백도 비슷하다.
    - 따라서 내부 트랜잭션에서 rollback-only 가 설정되면, 외부 트랜잭션도 커밋할 수 없게 된다.
        - 이때 외부 호출자에게도 이를 알려 인지할 수 있도록 해야 한다.
        - 따라서, 외부 트랜잭션이 스스로 롤백을 정한 것이 아니므로 UnexpectedRollbackException 예외를 발생시킨다.
        - 이는 롤백 필요성을 알려서 외부에서 롤백을 처리할 수 있도록 한다.
- 주의점
    - 기존 트랜잭션에 참여하는 것은 외부 범위의 특성을 가지며, 로컬의 격리 수준, timeout, read-only 설정이 무시된다.
    - 만약에 선언한 격리 수준이 다른 기존의 트랜잭션에 참여하는 것을 거부하고 싶다면 트랜잭션 매니저에 `validateExistingTransactions` 을 true 로 설정하면 된다.
    - true 인 경우엔 read-only 설정이 맞지 않을 때도 거부한다.
        - ex. read-only 외부 트랜잭션에 참여하려는 내부의 read-write 트랜잭션인 경우
```java
@Transactional(propagation = Propagation.REQUIRED)
public void inner() { ... }
```
## PROPAGATION_REQUIRES_NEW
- REQUIRED 와 반대로, 항상 새로운 물리 트랜잭션을 만든다.
- 서로 다른 물리 트랜잭션을 별도로 가지는 것은 각각의 db connection 이 사용되는 것과 같다.
- 특징
    - 따라서, 내부 트랜잭션은 외부 트랜잭션과 완전히 분리되어, 독립적으로 커밋하거나 롤백이 가능하다.
    - 내부 트랜잭션의 롤백 상태는 외부 트랜잭션에 영향을 주지 않는다.
    - 또한, 내부 트랜잭션에서 사용된 락은 완료 즉시 해제된다.
    - 각 내부 트랜잭션은 자신의 격리 수준, timeout, read-only 등을 선언할 수 있어, 외부 트랜잭션 속성을 상속받지 않는다.
- 주의점
    - 외부 트랜잭션에 묶인 리소스는 계속 유지되고, 내부 트랜잭션이 자신만의 리소스(ex. DB connection)를 따로 획득한다.
    - 만약, 여러 스레드가 외부 트랜잭션이 활성화된 상태로 내부 트랜잭션이 리소스를 얻기를 기다리면 `deadlock` 이 일어날 수 있다.
        - 커넥션 풀에서 더 이상 내부 트랜잭션의 커넥션 요청을 처리할 수 없는 경우
    - 따라서 REQUIRES_NEW 인 경우엔 커넥션 풀 크기를 충분히 설정하고, 동시 실행 스레드 수보다 최소 1개 이상은 크게 설정해야한다.
```java
@Transactional(propagation = Propagation.REQUIRES_NEW)
public void inner() { ... }
```
## PROPAGATION_NESTED
- 하나의 물리 트랜잭션 안에서 여러 개의 savepoint 를 사용하여, 각 포인트마다 부분 롤백을 할 수 있다.
- 따라서 롤백은 내부 트랜잭션 안에서만 진행되며, 롤백이 되어도 외부 트랜잭션은 계속해서 물리 트랜잭션을 이어갈 수 있다.
- 이 설정은 보통 JDBC의 세이브포인트 기능에 매핑되어 JDBC 리소스 트랜잭션에서만 동작한다.

## 이외의 트랜잭션 속성
### SUPPORTS
- 트랜잭션이 이미 존재한다면 지원한다.
- 기존 트랜잭션이 없는 경우엔 트랜잭션 없이 진행한다.
- 기존 트랜잭션이 있는 경우는 기존 트랜잭션에 참여한다.

### MANDATORY
- 트랜잭션이 의무이고, 반드시 필요함을 의미한다.
- 기존 트랜잭션이 없는 경우엔 IllegalTransactionStateException 예외 발생
- 기존 트랜잭션이 있는 경우엔 기존 트랜잭션에 참여한다.

### NOT_SUPPORTED
- 트랜잭션을 지원하지 않음을 의미한다.
- 기존 트랜잭션이 없을 땐 트랜잭션 없이 진행한다.
- 기존 트랜잭션이 있는 경우엔 트랜잭션을 보류시키고 트랜잭션 '없이' 진행한다.

### NEVER
- 말그대로 트랜잭션을 전혀 사용하지 않는다는 뜻
- 기존 트랜잭션이 없는 경우엔 그대로 트랜잭션 없이 진행한다.
- 기존 트랜잭션이 존재하는 경우엔 IllegalTransactionStateException 예외를 발생한다.




    
    


